DISC;

CONN SYSTEM/"projet";

DROP USER BDDADMIN CASCADE;

CREATE USER BDDADMIN IDENTIFIED BY TPAdmin;

GRANT ALL PRIVILEGES TO BDDADMIN;

GRANT UNLIMITED TABLESPACE TO BDDADMIN;

DISC;

CONN BDDADMIN/"TPAdmin";

CREATE TABLE ETUDIANT (
    MATRICULE_ETU NUMBER(8) PRIMARY KEY,
    NOM_ETU VARCHAR2(30),
    PRENOM_ETU VARCHAR2(30),
    DATE_NAISSANCE DATE
);

CREATE TABLE ENSEIGNANT (
    MATRICULE_ENS NUMBER(8),
    NOM_ENS VARCHAR2(30),
    PRENOM_ENS VARCHAR2(30),
    AGE INTEGER,
    CONSTRAINT PK_ENSEIGNANT PRIMARY KEY (MATRICULE_ENS)
);

CREATE TABLE UNITE (
    CODE_UNITE VARCHAR2(8) PRIMARY KEY,
    LIBELLE VARCHAR2(30),
    NBR_HEURES INTEGER CHECK (NBR_HEURES > 0),
    MATRICULE_ENS NUMBER(8) REFERENCES ENSEIGNANT (MATRICULE_ENS)
);

CREATE TABLE ETUDIANTUNITE (
    MATRICULE_ETU NUMBER(8) NOT NULL,
    CODE_UNITE VARCHAR2(8) NOT NULL,
    NOTE_CC NUMBER(4, 2) DEFAULT 0 CHECK (NOTE_CC<=20),
    NOTE_TP NUMBER(4, 2) DEFAULT 0 CHECK (NOTE_TP<=20),
    NOTE_EXAMEN NUMBER(4, 2) DEFAULT 0 CHECK (NOTE_EXAMEN<=20),
    CONSTRAINT FK_MATETU FOREIGN KEY (MATRICULE_ETU) REFERENCES ETUDIANT (MATRICULE_ETU),
    CONSTRAINT FK_UNITE FOREIGN KEY (CODE_UNITE) REFERENCES UNITE (CODE_UNITE),
    CONSTRAINT PK_ETUDIANTUNITE PRIMARY KEY (MATRICULE_ETU, CODE_UNITE)
);

DROP USER ETUDIANT CASCADE;

CREATE USER ETUDIANT IDENTIFIED BY TPEtudiant;

GRANT SELECT ON ETUDIANT TO ETUDIANT;

DROP USER ENSEIGNANT CASCADE;

CREATE USER ENSEIGNANT IDENTIFIED BY TPEnseignant;

GRANT CREATE SESSION TO BDDADMIN;

GRANT CREATE SESSION TO ETUDIANT;

GRANT CREATE SESSION TO ENSEIGNANT;

GRANT SELECT ON ETUDIANT TO ETUDIANT;

GRANT SELECT, INSERT ON ENSEIGNANT TO ENSEIGNANT;

ALTER TABLE ETUDIANT ADD ADRESSE VARCHAR2(100);

ALTER TABLE ENSEIGNANT DROP COLUMN AGE;

ALTER TABLE ETUDIANT ADD CONSTRAINT CHECK_MAT CHECK (MATRICULE_ETU>=20190000
AND MATRICULE_ETU <= 20199999);

ALTER TABLE ETUDIANT MODIFY (PRENOM_ETU VARCHAR2(35));

INSERT INTO ETUDIANT VALUES (
    20190001,
    'BOUSSAI',
    'MOHAMED',
    TO_DATE ('12-01-2000', 'DD-MM-YYYY'),
    'Alger'
);

INSERT INTO ETUDIANT VALUES (
    20190002,
    'CHAID',
    'LAMIA',
    TO_DATE ('01/10/1999', 'DD-MM-YYYY'),
    'Batna'
);

INSERT INTO ETUDIANT VALUES (
    20190003,
    'BRAHIMI',
    'SOUAD',
    TO_DATE ('18/11/2000', 'DD-MM-YYYY'),
    'Sétif'
);

INSERT INTO ETUDIANT VALUES (
    20190004,
    'LAMA',
    'SAID',
    TO_DATE ('23/05/1999', 'DD-MM-YYYY'),
    'Oran'
);

INSERT INTO ENSEIGNANT VALUES(
    20000001,
    'HAROUNI',
    'AMINE'
);

INSERT INTO ENSEIGNANT VALUES(
    19990011,
    'FATHI',
    'OMAR'
);

INSERT INTO ENSEIGNANT VALUES(
    19980078,
    'BOUZIDANE',
    'FARAH'
);

INSERT INTO ENSEIGNANT VALUES(
    20170015,
    'ARABI',
    'ZOUBIDA'
);

INSERT INTO UNITE VALUES (
    'FEI0001',
    'POO',
    6,
    20000001
);

INSERT INTO UNITE VALUES(
    'FEI0002',
    'BDD',
    6,
    19990011
);

INSERT INTO UNITE VALUES(
    'FEI0003',
    'RESEAU',
    3,
    20170015
);

INSERT INTO UNITE VALUES(
    'FEI0004',
    'SYSTEME',
    6,
    19980078
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190001,
    'FEI0001',
    10,
    15,
    09
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190002,
    'FEI0001',
    20,
    13,
    10
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190004,
    'FEI0001',
    13,
    17,
    16
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190002,
    'FEI0002',
    10,
    16,
    17
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190003,
    'FEI0002',
    09,
    08,
    15
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190004,
    'FEI0002',
    15,
    09,
    20
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190002,
    'FEI0004',
    12,
    18,
    14
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190003,
    'FEI0004',
    17,
    12,
    15
);

INSERT INTO ETUDIANTUNITE VALUES (
    20190004,
    'FEI0004',
    12,
    13,
    20
);

UPDATE ETUDIANTUNITE
SET
    NOTE_CC=NOTE_CC+2
WHERE
    MATRICULE_ETU IN (
        SELECT MATRICULE_ETU FROM ETUDIANT WHERE NOM_ETU LIKE 'B%'
    );

UPDATE ETUDIANTUNITE
SET
    NOTE_EXAMEN=0
WHERE
    CODE_UNITE IN(
        SELECT CODE_UNITE FROM UNITE WHERE LIBELLE='SYSTEME'
    );

COMMIT;
/*Afficher les noms et prénoms des étudiants ayant obtenu des notes d'examens égales à 20.*/
SELECT
    NOM_ETU,
    PRENOM_ETU
FROM
    ETUDIANT
WHERE
    MATRICULE_ETU IN (
        SELECT
            MATRICULE_ETU
        FROM
            ETUDIANTUNITE
        WHERE
            NOTE_EXAMEN=20
    );

/*Afficher les noms et prénoms des étudiants qui ne sont pas inscrits dans l'unité « POO ».*/

SELECT
    NOM_ETU,
    PRENOM_ETU
FROM
    ETUDIANT
WHERE
    MATRICULE_ETU NOT IN (
        SELECT
            MATRICULE_ETU
        FROM
            ETUDIANTUNITE
        WHERE
            CODE_UNITE IN (
                SELECT
                    CODE_UNITE
                FROM
                    UNITE
                WHERE
                    LIBELLE='POO'
            )
    );

-- Afficher les libellés des unités d'enseignement dont aucun étudiant n'est inscrit.
SELECT
    LIBELLE
FROM
    UNITE
WHERE
    CODE_UNITE NOT IN (
        SELECT
            CODE_UNITE
        FROM
            ETUDIANTUNITE
    );

-- /* Afficher pour chaque étudiant, son nom, son prénom sa moyenne par unité d'enseignement
-- ainsi que le libellé de l'unité. */

SELECT
    E.NOM_ETU,
    E.PRENOM_ETU,
    (EU.NOTE_CC + EU.NOTE_TP + EU.NOTE_EXAMEN) / 3 AS MOYENNE,
    U.LIBELLE
FROM
    ETUDIANT      E,
    ETUDIANTUNITE EU,
    UNITE         U
WHERE
    E.MATRICULE_ETU = EU.MATRICULE_ETU
    AND EU.CODE_UNITE = U.CODE_UNITE
GROUP BY
    E.NOM_ETU,
    E.PRENOM_ETU,
    U.LIBELLE,
    (EU.NOTE_CC + EU.NOTE_TP + EU.NOTE_EXAMEN) / 3;